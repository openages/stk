import{a as v}from"../mobx/index.js";import"../storage/index.js";import{find as w,flatten as I,flatMap as A,get as u,initial as R,last as h,omit as N,reduceRight as M}from"lodash-es";import{makeAutoObservable as E,toJS as d}from"mobx";class g{tree=[];constructor(){E(this,null,{autoBind:!0})}init(r){let t=this.getRawTreeMap(r),{tree:e,tree_map:n,lost_tree:i}=this.getTree(r,t),{tree:o,lost_tree:s}=this.sortTree(e,n,i);return this.tree=o,s}find(r,t){let e=t||this.tree;for(let n=0;n<e.length;n++){let i=e[n];if(i.id===r)return i;if(i.children)return this.find(r,i.children)}}insert(r,t){let{target_level:e,cloned_item:n}=this.getDroppableItem(t),{active_item:i,effect_items:o}=this.place({type:"push",active_item:r,over_item:n,target_level:e});return{item:i,effect_items:o}}remove(r){let{cloned_item:t,effect_items:e}=this.take(r),n=[];if(t?.children?.length)n=this.getherItems(t.children);return{id:t.id,remove_items:n,effect_items:e}}update(r,t){if(!r.length){let s=this.find(t.id);if(!s)return;Object.keys(N(t,"id")).forEach((a)=>{s[a]=t[a]});return}let{item:e,target_level:n,target_index:i}=this.getItem(r),o={...e,...t};return n[i]=o,o}move(r){let{active_parent_index:t,over_parent_index:e,droppable:n}=r,i=[],{cloned_item:o}=this.getItem(t),{cloned_item:s,target_level:a}=n?this.getDroppableItem(e):this.getItem(e);if(s.next_id===o.id&&!n)return{effect_items:i};let y=o.next_id===s.id&&!n,c=[],f=()=>{let{effect_items:l}=this.place({type:n?"push":"insert",active_item:o,over_item:s,target_level:a,over_index:h(e)});return l},p=()=>{let{effect_items:l}=this.take(t,y);return l};if(o.pid===s.pid)if(h(t)<h(e))c=[f,p];else c=[p,f];else if(t.length>e.length)c=[p,f];else c=[f,p];let b=I(c.map((l)=>l()));return{effect_items:this.getUniqEffectItems(b)}}getItem(r){let t=[],e=0,n=null,i=this.getIndexes(r),o=R(i);if(e=h(r),n=u(this.tree,i),!o.length)t=this.tree;else t=u(this.tree,o);return{item:n,cloned_item:d(n),target_level:t,target_index:e}}getDroppableItem(r){if(!r.length)return{target_level:this.tree,cloned_item:null};let t=null,e=[];if(r.length===1)e=r;else e=this.getIndexes(r);if(t=u(this.tree,e),!t.children)t.children=[];return{target_level:t.children,cloned_item:d(t)}}getRawTreeMap(r){let t={};return r.map((e)=>{t[e.id]=e}),t}getTree(r,t){let e=[],n=[];return r.forEach((i)=>{let o=t[i.prev_id],s=t[i.next_id];if(i.prev_id===i.next_id||!t[i.id]||o&&o.prev_id===o.next_id||s&&s.prev_id===s.next_id)i.prev_id=void 0,i.next_id=void 0,i.pid=void 0,t[i.id]=i,n.push(i);else if(i.pid){if(!t[i.pid].children)t[i.pid].children=[];if(!t[i.pid]?.children?.length)t[i.pid].children=[i];else t[i.pid].children.push(i)}else e.push(i)}),{tree:e,tree_map:t,lost_tree:n}}sortTree(r,t,e){let n=[],i=w(r,(s)=>!s.prev_id);if(!i){if(e&&e.length){let s=this.sortLostTree(e,t);return{tree:s,lost_tree:s}}return{tree:[],lost_tree:[]}}let o=i.id;while(o){let s=t[o];if(s?.children?.length)s.children=this.sortTree(s.children,t).tree;n.push(s),o=s.next_id}if(e&&e.length){let s=this.sortLostTree(e,t);s[0].prev_id=n.at(-1).id,n.push(...s)}return{tree:n,lost_tree:e}}sortLostTree(r,t){return r.map((e,n)=>{let i=r.at(n+1);if(i)e.next_id=i.id,i.prev_id=e.id,t[e.id]=e,t[i.id]=i;return e})}take(r,t){let{cloned_item:e,target_level:n,target_index:i}=this.getItem(r),o=[];if(e.prev_id){let s=n[i-1];s.next_id=e.next_id??"",o.push(d(s))}if(e.next_id){let s=n[i+1];if(s.prev_id=e.prev_id??"",t)s.next_id=e.id;o.push(d(s))}return n.splice(i,1),{cloned_item:e,effect_items:o}}place(r){let{type:t,active_item:e,over_item:n,target_level:i,over_index:o}=r,s=[];if(t==="push"){if(e.pid=n?n.id:"",i.length){let a=h(i);a.next_id=e.id,e.prev_id=a.id,s.push(d(a))}else e.prev_id=void 0;e.next_id=void 0,s.push(d(e)),i.push(e)}else{if(e.pid=n.pid,e.prev_id=n.id,e.next_id=n.next_id,n.next_id){let a=i[o+1];a.prev_id=e.id,s.push(d(a))}else e.next_id=void 0;if(e.next_id===n.id)n.next_id=e.next_id;else n.next_id=e.id;s.push(d(e)),s.push(d(n)),i.splice(o+1,0,e)}return{active_item:e,effect_items:s}}getUniqEffectItems(r){return M(r,(t,e)=>{if(!t.some((n)=>n.id===e.id))t.unshift(e);return t},[])}getIndexes(r){return A(r,(t,e)=>{return e<r.length-1?[t,"children"]:[t]})}getherItems(r){return r.reduce((t,e)=>{if(t.push(e),e?.children?.length)t.push(...this.getherItems(e.children));return t},[])}}import{debounce as x}from"lodash-es";import{makeAutoObservable as k}from"mobx";var m=(r,t,e)=>{t.forEach((n)=>{r.addEventListener(n,x(e,900,{leading:!0}))})},_=(r,t,e)=>{t.forEach((n)=>{r.removeEventListener(n,x(e,900,{leading:!0}))})};class T{config={context:null,events:["mousemove","scroll","keydown","mousedown","touchstart"],onIdle:null,onActive:null,onHide:null,onShow:null};time=60000;idle=!1;visible=!0;timer=null;acts=[];watch={time:(r)=>{if(this.off(),r)this.on()}};constructor(){k(this,{config:!1,timer:!1,acts:!1},{autoBind:!0}),this.acts=[...v(this)]}init(r,t){if(!r)return;this.time=r,this.config=Object.assign(this.config,t),this.on()}on(){if(this.start(),m(window,this.config.events,this.active.bind(this.config.context??this)),this.config.onShow||this.config.onHide)m(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}off(){if(this.timer)clearTimeout(this.timer);if(this.acts.map((r)=>r()),_(window,this.config.events,this.active.bind(this.config.context??this)),this.config.onShow||this.config.onHide)_(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}start(){if(this.timer)clearTimeout(this.timer);this.timer=setTimeout(()=>{this.idle=!0,this.config.onIdle&&this.config.onIdle.call(this.config.context??this)},this.time)}active(){if(this.idle)this.idle=!1,this.config.onActive&&this.config.onActive.call(this.config.context??this);this.start()}changeVisible(){if(document.hidden){if(this.visible)this.visible=!1,this.config.onHide&&this.config.onHide.call(this.config.context??this)}else if(!this.visible)this.visible=!0,this.config.onShow&&this.config.onShow.call(this.config.context??this)}}var L=(r,t)=>{let e={};return r.forEach((n)=>{let i=n[t];e[i]=n}),Object.values(e)};var D=(r)=>{if(!r)r=30;let t="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",e=new Uint8Array(r);window.crypto.getRandomValues(e);let n="";for(let i=0;i<r;i++)n+=t[e[i]%t.length];return n};export{L as uniqBy,D as id,T as Idle,g as DirTree};
