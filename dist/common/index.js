import{a as v}from"../mobx/index.js";import"../storage/index.js";import{find as w,flatMap as I,flatten as A,get as m,initial as R,last as h,omit as N,reduceRight as M}from"lodash-es";import{makeAutoObservable as E,toJS as c}from"mobx";class u{tree=[];constructor(){E(this,null,{autoBind:!0})}init(r){const t=this.getRawTreeMap(r),{tree:e,tree_map:i}=this.getTree(r,t);this.tree=this.sortTree(e,i)}find(r,t){const e=t||this.tree;for(let i=0;i<e.length;i++){const n=e[i];if(n.id===r)return n;if(n.children)return this.find(r,n.children)}}insert(r,t){const{target_level:e,cloned_item:i}=this.getDroppableItem(t),{active_item:n,effect_items:s}=this.place({type:"push",active_item:r,over_item:i,target_level:e});return{item:n,effect_items:s}}remove(r){const{cloned_item:t,effect_items:e}=this.take(r);let i=[];if(t?.children?.length)i=this.getherItems(t.children);return{id:t.id,remove_items:i,effect_items:e}}update(r,t){if(!r.length){const o=this.find(t.id);if(!o)return;Object.keys(N(t,"id")).forEach((a)=>{o[a]=t[a]});return}const{item:e,target_level:i,target_index:n}=this.getItem(r),s={...e,...t};return i[n]=s,s}move(r){const{active_parent_index:t,over_parent_index:e,droppable:i}=r,n=[],{cloned_item:s}=this.getItem(t),{cloned_item:o,target_level:a}=i?this.getDroppableItem(e):this.getItem(e);if(o.next_id===s.id&&!i)return{effect_items:n};const b=s.next_id===o.id&&!i;let d=[];const f=()=>{const{effect_items:l}=this.place({type:i?"push":"insert",active_item:s,over_item:o,target_level:a,over_index:h(e)});return l},p=()=>{const{effect_items:l}=this.take(t,b);return l};if(s.pid===o.pid)if(h(t)<h(e))d=[f,p];else d=[p,f];else if(t.length>e.length)d=[p,f];else d=[f,p];const x=A(d.map((l)=>l()));return{effect_items:this.getUniqEffectItems(x)}}getItem(r){let t=[],e=0,i=null;const n=this.getIndexes(r),s=R(n);if(e=h(r),i=m(this.tree,n),!s.length)t=this.tree;else t=m(this.tree,s);return{item:i,cloned_item:c(i),target_level:t,target_index:e}}getDroppableItem(r){if(!r.length)return{target_level:this.tree,cloned_item:null};let t=null,e=[];if(r.length===1)e=r;else e=this.getIndexes(r);if(t=m(this.tree,e),!t.children)t.children=[];return{target_level:t.children,cloned_item:c(t)}}getRawTreeMap(r){const t={};return r.map((e)=>{t[e.id]=e}),t}getTree(r,t){const e=[];return r.forEach((i)=>{if(i.pid){if(!t[i.pid].children)t[i.pid].children=[];if(!t[i.pid]?.children?.length)t[i.pid].children=[i];else t[i.pid].children.push(i)}else e.push(i)}),{tree:e,tree_map:t}}sortTree(r,t){const e=[],i=w(r,(s)=>!s.prev_id);if(!i)return[];let n=i.id;while(n){const s=t[n];if(s?.children?.length)s.children=this.sortTree(s.children,t);e.push(s),n=s.next_id}return e}take(r,t){const{cloned_item:e,target_level:i,target_index:n}=this.getItem(r),s=[];if(e.prev_id){const o=i[n-1];o.next_id=e.next_id??"",s.push(c(o))}if(e.next_id){const o=i[n+1];if(o.prev_id=e.prev_id??"",t)o.next_id=e.id;s.push(c(o))}return i.splice(n,1),{cloned_item:e,effect_items:s}}place(r){const{type:t,active_item:e,over_item:i,target_level:n,over_index:s}=r,o=[];if(t==="push"){if(e.pid=i?i.id:"",n.length){const a=h(n);a.next_id=e.id,e.prev_id=a.id,o.push(c(a))}else e.prev_id=void 0;e.next_id=void 0,o.push(c(e)),n.push(e)}else{if(e.pid=i.pid,e.prev_id=i.id,e.next_id=i.next_id,i.next_id){const a=n[s+1];a.prev_id=e.id,o.push(c(a))}else e.next_id=void 0;if(e.next_id===i.id)i.next_id=e.next_id;else i.next_id=e.id;o.push(c(e)),o.push(c(i)),n.splice(s+1,0,e)}return{active_item:e,effect_items:o}}getUniqEffectItems(r){return M(r,(t,e)=>{if(!t.some((i)=>i.id===e.id))t.unshift(e);return t},[])}getIndexes(r){return I(r,(t,e)=>{return e<r.length-1?[t,"children"]:[t]})}getherItems(r){return r.reduce((t,e)=>{if(t.push(e),e?.children?.length)t.push(...this.getherItems(e.children));return t},[])}}import{debounce as y}from"lodash-es";import{makeAutoObservable as k}from"mobx";var T=(r,t,e)=>{t.forEach((i)=>{r.addEventListener(i,y(e,900,{leading:!0}))})},_=(r,t,e)=>{t.forEach((i)=>{r.removeEventListener(i,y(e,900,{leading:!0}))})};class g{config={context:null,events:["mousemove","scroll","keydown","mousedown","touchstart"],onIdle:null,onActive:null,onHide:null,onShow:null};time=60000;idle=!1;visible=!0;timer=null;acts=[];watch={time:(r)=>{if(this.off(),r)this.on()}};constructor(){k(this,{config:!1,timer:!1,acts:!1},{autoBind:!0}),this.acts=[...v(this)]}init(r,t){if(!r)return;this.time=r,this.config=Object.assign(this.config,t),this.on()}on(){if(this.start(),T(window,this.config.events,this.active.bind(this.config.context??this)),this.config.onShow||this.config.onHide)T(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}off(){if(this.timer)clearTimeout(this.timer);if(this.acts.map((r)=>r()),_(window,this.config.events,this.active.bind(this.config.context??this)),this.config.onShow||this.config.onHide)_(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}start(){if(this.timer)clearTimeout(this.timer);this.timer=setTimeout(()=>{this.idle=!0,this.config.onIdle&&this.config.onIdle.call(this.config.context??this)},this.time)}active(){if(this.idle)this.idle=!1,this.config.onActive&&this.config.onActive.call(this.config.context??this);this.start()}changeVisible(){if(document.hidden){if(this.visible)this.visible=!1,this.config.onHide&&this.config.onHide.call(this.config.context??this)}else if(!this.visible)this.visible=!0,this.config.onShow&&this.config.onShow.call(this.config.context??this)}}var D=(r,t)=>{const e={};return r.forEach((i)=>{const n=i[t];e[n]=i}),Object.values(e)};var P=(r)=>{if(!r)r=30;const t="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",e=new Uint8Array(r);window.crypto.getRandomValues(e);let i="";for(let n=0;n<r;n++)i+=t[e[n]%t.length];return i};export{D as uniqBy,P as id,g as Idle,u as DirTree};
